name: Infra
type: super
variables:
  region: us-east-1
  core_count: 2
  emr_version: 'emr-5.28.0'
  template_url: 'https://github.com/awslabs/aws-cloudformation-templates/blob/master/aws/services/EMR/EMRClusterWithAdditioanalSecurityGroups.json'
executors:
  - executor: emr-executor
    cluster_name: '{{cluster_name}}'
    type: emr
  - executor: k8s-executor
    type: kubernetes
task_defaults:
  spark:
    executor: emr-executor
    master: yarn
    deploy_mode: cluster
    conf:
      spark.sql.hive.verifyPartitionPath: true
  python:
    executor: k8s-executor
pipeline_defaults:
  before_tasks:
    - task: create_emr
      type: create_cloudformation_stack
      description: create emr
      stack_name: '{{cluster_name}}'
      properties:
        TimeoutInMinutes: 25
        Capabilities: [ 'CAPABILITY_NAMED_IAM' ]
        TemplateURL: '{{template_url}}'
        Parameters:
          EMRClusterName: '{{cluster_name}}'
          FileBeatLogTypeName: '{{cluster_name}}'
          MasterServerCount: '1'
          CoreServerCount: '{{core_count}}'
          EmrApplicationRelease: '{{emr_version}}'
          InstanceTypeMaster: m5.xlarge
          InstanceTypeCore: m5.xlarge
          EmrFleet: 'yes'
  after_tasks:
    - task: delete_emr
      type: delete_cloudformation_stack
      stack_name: '{{cluster_name}}'
      description: delete stack
